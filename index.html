<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.49" />

    

<title>Midnight Programmer</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Midnight Programmer"/>
<meta name="twitter:description" content="Programming For Fun"/>

<meta property="og:title" content="Midnight Programmer" />
<meta property="og:description" content="Programming For Fun" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://prashantkhandelwal.github.io/" />
<meta property="og:updated_time" content="2023-05-04T11:27:00&#43;00:00"/><meta property="og:site_name" content="Midnight Programmer" />


    


<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/print.css" media="print">


    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

<link href="https://prashantkhandelwal.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Midnight Programmer" />
<link href="https://prashantkhandelwal.github.io/index.xml" rel="feed" type="application/rss+xml" title="Midnight Programmer" />


</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://prashantkhandelwal.github.io/">Midnight Programmer</a>
      </span>
      
      
      
      <div class="author-image">
        <img src="https://prashantkhandelwal.github.io//img/prashantk.jpg" alt="Author Image" class="img--circle img--headshot element--center"> 
      </div>
      
      <p class="site__description">
         Programming For Fun 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Midnight Programmer</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/archive/"><i class='fa fa-road'></i>
						<span>Archive</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/top-posts/"><i class='fa fa-star fa-fw'></i>
						<span>Top Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/contact/"><i class='fa fa-envelope fa-fw'></i>
						<span>Contact</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/nullgap" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://facebook.com/khandelwal.p" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/prashantkhandelwal" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="http://feeds.feedburner.com/MidnightProgrammer" rel="me"><i class="fa fa-rss fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://instagram.com/prashantkhandelwal" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/khandelwalprashant" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://medium.com/@prashantkhandelwal" rel="me"><i class="fab fa-medium fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
</section>

      </div>
    </div>
    <p class="copyright">
      &copy; 2023 Pashant Khandelwal
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.5/in/"><img style="border-width: 0;" src="https://i.creativecommons.org/l/by-nc-sa/2.5/in/88x31.png" alt="Creative Commons License" class="thinglinkFiltered"></a>
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
<div class="post-list">
  
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/create-azure-resources-programmatically-by-executing-terraform-commands-in-go/">Create Azure Resources Programmatically By Executing Terraform Commands in Go</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> May 4, 2023
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/automation">AUTOMATION</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/azure">AZURE</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/devops">DEVOPS</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/go">GO</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/terraform">TERRAFORM</a>
      
      
      
      
    </span>
    

<p><a href="https://www.terraform.io/">Terraform</a> is my go-to IAC tool for building my infrastructure in Azure. I usually use Azure DevOps pipeline to execute my terraform plan, but it would be nice to know if I can execute it programmatically or on request basis. Even on request basis you can trigger a CI/CD pipeline to provision the infrastructure but maybe it is too much for a simple project to have.</p>

<p>One of the biggest pain points has been the authentication in command line tooling. I can execute my terraform plan if I have <code>az cli login</code> done on the shell/terminal I am using. I can also perform the same operation programmatically, but it will still open up a web browser and ask me for authentication. I don’t want user intervention when performing this operation. So, the way I can achieve this is by using <code>Service Principal</code>.</p>

<blockquote>
<p>You can also make use of Managed Service Identity or MSI but not all Azure resources support this. You can check the list of the resources <a href="https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/managed-identities-status">here</a>.</p>
</blockquote>

<p>The service principal I am planning to use will let me create any Azure resource. This is equivalent to <code>az login cli</code> command.</p>

<h3 id="setting-up-azure"><strong>Setting up Azure</strong></h3>

<p>Add a new <code>App registration</code> in Azure Active Directory. Give a name to your application and then select <code>Redirect URI</code> to be web and <code>URL</code> can be left blank. Click <code>Register</code> to create an application.</p>

<p><img src="/images/az-ad-appreg.png" alt="Azure AD app registration" /></p>

<p>In the Overview section, copy the <code>client id</code> and <code>tenant id</code>. You also need to have a <code>subscription id</code> which you can find in your Active Directory or in your subscription resource in the portal.</p>

<p><img src="/images/az-ad-appoverview.png" alt="Azure AD app overview" /></p>

<p>Click on <code>Certificates &amp; secrets</code>, and then click <code>+ New client secret</code>. Follow the instructions to create a new secret and once done, you should be presented with a secret which you should copy and save somewhere safe (preferably in Azure KeyVault) as this is the only time it will be visible to you.</p>

<p><img src="/images/az-ad-appids.png" alt="Azure app client secret" /></p>

<p>In the end you should have these values with you:</p>

<ul>
<li>Client Id</li>
<li>Client Secret</li>
<li>Subscription Id</li>
<li>Tenant Id</li>
</ul>

<p>Now if you try creating a new resource using Terraform, it will fail as the service principal does not have permissions to manage resources in your subscription. To grant permissions, go to <code>Subscriptions</code> in Azure portal and click <code>Access control (IAM)</code>.</p>

<p><img src="/images/az-subscription-iam.png" alt="Azure subscription IAM" /></p>

<p>Click on <code>Add role assignment</code> and then click <code>Privileged administrator roles</code>.</p>

<p><img src="/images/az-sub-iam-role.png" alt="Azure subscription IAM role" /></p>

<p>You can ignore the warning shown at the bottom, we need this option for adding <code>contributor</code> access to the subscription we want to manage.</p>

<p><img src="/images/az-sub-iam-role-assign.png" alt="Azure subscription IAM role assignment" /></p>

<p>Select <code>Contributor</code> from the list and click <code>Next</code>.</p>

<p><img src="/images/az-sub-iam-members.png" alt="Azure subscription IAM members" /></p>

<p>Select <code>User, group or service principal</code> and click <code>+ Select members</code>.</p>

<p><img src="/images/az-sub-iam-selectmem.png" alt="Azure subscription IAM select members" /></p>

<p>Search your application by name, select it and then click <code>Select</code>. Verify the details in the last step and click <code>Review + assign</code>.</p>

<p><img src="/images/az-sub-iam-review.png" alt="Azure subscription IAM review" /></p>

<p>Back to the <code>Access controls (IAM)</code> blade, you can see the role assignment to the subscription.</p>

<p><img src="/images/az-sub-iam-roles.png" alt="Azure subscription review roles" /></p>

<h3 id="setting-up-go-project"><strong>Setting up Go project</strong></h3>

<p>Let’s see with a very basic example of getting this done programmatically. Setup a new go project and import these packages.</p>

<pre class="brush:ruby">
import (
    "fmt"
    "log"
    "os"

    "github.com/hashicorp/go-version"
    "github.com/hashicorp/hc-install/product"
    "github.com/hashicorp/hc-install/releases"
)
</pre>

<p>In the <code>main</code> function, add the below code:</p>

<pre class="brush:ruby">
os.Setenv("ARM_CLIENT_ID", "")
os.Setenv("ARM_CLIENT_SECRET", "")
os.Setenv("ARM_TENANT_ID", "")
os.Setenv("ARM_SUBSCRIPTION_ID", "")

//az login --service-principal -u CLIENT_ID -p CLIENT_SECRET --tenant TENANT_ID
cmd := exec.Command("az", "login", "--service-principal", "-u", os.Getenv("ARM_CLIENT_ID"), "-p", os.Getenv("ARM_CLIENT_SECRET"), "--tenant", os.Getenv("ARM_TENANT_ID"))
var stdoutBuf, stderrBuf bytes.Buffer
cmd.Stdout = io.MultiWriter(os.Stdout, &stdoutBuf)
cmd.Stderr = io.MultiWriter(os.Stderr, &stderrBuf)
err := cmd.Run()
if err != nil {
    log.Fatalf("cmd.Run() failed with %s\n", err)
}

outStr := string(stdoutBuf.Bytes())
fmt.Println(outStr)
</pre>

<p>The first thing we did was to set environment variables.</p>

<blockquote>
<p>Name the environment variables as shown in the above example. These are the same names which are internally used by Terraform.</p>
</blockquote>

<p>Normally I would use a service principal like this:</p>

<pre class="brush:bash">
$ az login --service-principal -u CLIENT_ID -p CLIENT_SECRET --tenant TENANT_ID 
</pre>

<p>As we are automating this process, we can use the exec.Command to execute this command with parameters like this:</p>

<pre class="brush:ruby">
cmd := exec.Command("az", "login", "--service-principal", "-u", os.Getenv("ARM_CLIENT_ID"), "-p", os.Getenv("ARM_CLIENT_SECRET"), "--tenant", os.Getenv("ARM_TENANT_ID")) 
</pre>

<p>This will get the service principal and assign it to the terminal where this application will be running.</p>

<p><img src="/images/tf-command-test.png" alt="az cli output" /></p>

<p>Moving ahead you can remove or comment out the above code and leave the environment variables as is in the code file.</p>

<p>As a next step you can also take the terraform binary from the environment variable and automate the execution just like above. But there is an efficient way of doing this and for that we must make slight changes to our code.</p>

<p>First, we need to check if terraform is installed on the machine or not. On my machine I have Terraform installed and added to the environment with the name <code>terraform</code>. In Go, I can get this path with the help of <code>os.Getenv</code> and pass in the name of the environment variable <code>terraform</code>.</p>

<p>If the path exists, then I will use that path and if not then I can install a specific version of Terraform. Here is the is the complete code for the above explanation:</p>

<pre class="brush:ruby">
package main

import (
    "context"
    "log"
    "os"

    "github.com/hashicorp/go-version"
    "github.com/hashicorp/hc-install/product"
    "github.com/hashicorp/hc-install/releases"
)

func main() {

    var execPath string
    var tfInstallDir string
    var err error
    tfBin := os.Getenv("terraform")

    if len(tfBin) > 0 {
        log.Printf("Found Terraform: %s", tfBin)
        execPath = filepath.Join(tfBin, "terraform.exe")
    } else {
        log.Print("Terraform not found....installing")
        installer := &releases.ExactVersion{
            Product: product.Terraform,
            Version: version.Must(version.NewVersion("1.4.6")),
        }

        wd, _ := os.Getwd()
        tfInstallDir = filepath.Join(wd, "tf")
        if _, err := os.Stat(tfInstallDir); err != nil {
            log.Printf("Installation directory not found...creating")
            if err = os.MkdirAll(tfInstallDir, os.ModePerm); err != nil {
                log.Fatalf("ERROR: Cannot create \"%s\" directory - %v", tfInstallDir, err.Error())
                panic(err)
            }

            installer.InstallDir = tfInstallDir

            log.Printf("Installing version: %s", installer.Version.String())

            execPath, err = installer.Install(context.Background())
            if err != nil {
                log.Fatalf("Error installing Terraform: %s", err)
            }

            execPath = filepath.Join(installer.InstallDir, "terraform.exe")
            log.Printf("Installed Terraform %s at %s", installer.Version.String(), execPath)
        } else {
            execPath = filepath.Join(tfInstallDir, "terraform.exe")
            log.Printf("Terraform %s found at %s", installer.Version.String(), execPath)
        }
    }
}
</pre>

<p>The above program first looks for the <code>terraform</code> environment variable and tries to get the value for it. If the value exists, <code>execPath</code> variable will hold its value. If not meaning that Terraform is not installed on this machine and requires installation. The two packages that will help us installing the right version of Terraform are:</p>

<ul>
<li>github.com/hashicorp/hc-install/product</li>
<li>github.com/hashicorp/hc-install/releases</li>
</ul>

<p>We first prepare the <code>installer</code> by providing the details of the product we want to install, in our case, it is <code>Terraform</code>. You can provide a specific version based on your requirements. If you want to install any specific version like <code>1.0.6</code> etc. You can provide the version number and it will be installed.</p>

<p>The <code>installer.Install</code> function will take in the <code>context</code> which will run in the <code>background</code> and perform the installation for us. Once the installation is completed, you can see the path of the Terraform binary.</p>

<p>Note that if I have not provided an installation path or a directory, the installation will be done in a temp location of your machine. If you don’t want the installation to be done in a temporary location and also want to speed up the execution, then set the <code>InstallDir</code> property to set the path for installation.</p>

<blockquote>
<p>Check the GitHub gist below for <code>InstallDir</code> implementation.</p>
</blockquote>

<p>Next, we set up the working directory where our Terraform code is. We need to import a new package called <code>tfexec</code>:</p>

<pre class="brush:bash">
"github.com/hashicorp/terraform-exec/tfexec"
</pre>

<p>and the code:</p>

<pre class="brush:ruby">
workingDir := "iac" 
tf, err := tfexec.NewTerraform(workingDir, execPath) 
if err != nil { 
  log.Fatalf("Error running NewTerraform: %s", err) 
} 
</pre>

<p>The <code>NewTerrafrom</code> function takes in two parameters. First is the <code>working directory</code> where you have kept your <code>.tf</code> files and the second one is the <code>execPath</code>, which is the executable path of the Terraform binary.</p>

<p>After this we can perform terraform <code>init</code> and <code>apply</code> like this:</p>

<pre class="brush:ruby">
log.Print("Start executing TF Init")
err = tf.Init(context.Background(), tfexec.Upgrade(true))
if err != nil {
    log.Fatalf("Error running Init: %s", err)
}

log.Print("Finished running TF Init")

log.Print("Start running TF Apply")
err = tf.Apply(context.Background())
if err != nil {
    log.Fatalf("Error running Apply: %s", err)
}

log.Print("Finished running TF Apply")
</pre>

<p>Both <code>init</code> and <code>apply</code> code are simple to understand. The last one is the <code>show</code> command. If you have worked with terraform cli, you also want to show the <code>output</code> after <code>terraform apply</code> has been successful. The <code>output</code> variables defined in your <code>.tf</code> files will return values like IP address of the virtual machine or the DNS name which you can save or use somewhere else.</p>

<p>These are the contents of my <code>output.tf</code> file:</p>

<pre class="brush:bash">
output "public_ip_address" {
  value = azurerm_linux_virtual_machine.popcorndbvm.public_ip_address
}

output "tls_private_key" {
  value     = tls_private_key.popcornssh.private_key_openssh
  sensitive = true
}
</pre>

<p>We can also check if the output is marked as <code>sensitive</code> or not. You can see here that I have marked <code>tls_private_key</code> as <code>sensitive</code>. When you traverse the output variables, you can check the <code>Sensitive</code> property and prevent the value to be displayed in your terminal. Below is the code that does the same thing:</p>

<pre class="brush:ruby">
state, err := tf.Show(context.Background())
if err != nil {
    log.Fatalf("Error running Show: %s", err)
}

for s, i := range state.Values.Outputs {
    val := i.Value
    if s == "tls_private_key" && i.Sensitive {
        data := val.(string)
        err := ioutil.WriteFile("propcornvm_key.key", []byte(data), 0)
        if err != nil {
            log.Fatalf("Cannot save private key to the local machine. - %s", err.Error())
        } else {
            fmt.Printf("Private Key saved: %s\n", "propcornvm_key.key")
        }
    } else {
        fmt.Printf("%s : %s", s, val)
        fmt.Println()
    }
}
</pre>

<p>The <code>state</code> variable is a pointer to <code>*tfjson.State</code> and once it runs successfully the output will be stored in a <code>map[string]*tfjson</code>.<code>StateOutput</code>, which we can iterate over to get the values of the <code>output</code> variables.</p>

<p>? NOTE: You can use my terraform files to create a web app, app service plan, Linux virtual machine etc. You can view these files <a href="https://github.com/prashantkhandelwal/Popcorn/tree/main/Deployment/Azure">here</a>.</p>

<p>Here is the complete code. You need to update the environment variables and replace them with the variables you have obtained from Azure portal. Set <code>workingDir</code> variable with the name of the path where your <code>tf</code> files are.</p>

<pre class="brush:ruby">
package main

import (
    "context"
    "fmt"
    "io/ioutil"
    "log"
    "os"
    "path/filepath"

    "github.com/hashicorp/go-version"
    "github.com/hashicorp/hc-install/product"
    "github.com/hashicorp/hc-install/releases"
    "github.com/hashicorp/terraform-exec/tfexec"
)

func main() {

    // Update these environment variables with yours.
    os.Setenv("ARM_CLIENT_ID", "")
    os.Setenv("ARM_CLIENT_SECRET", "")
    os.Setenv("ARM_TENANT_ID", "")
    os.Setenv("ARM_SUBSCRIPTION_ID", "")

    //az login --service-principal -u CLIENT_ID -p CLIENT_SECRET --tenant TENANT_ID
    // cmd := exec.Command("az", "login", "--service-principal", "-u", os.Getenv("ARM_CLIENT_ID"), "-p", os.Getenv("ARM_CLIENT_SECRET"), "--tenant", os.Getenv("ARM_TENANT_ID"))
    // var stdoutBuf, stderrBuf bytes.Buffer
    // cmd.Stdout = io.MultiWriter(os.Stdout, &stdoutBuf)
    // cmd.Stderr = io.MultiWriter(os.Stderr, &stderrBuf)
    // err := cmd.Run()
    // if err != nil {
    //  log.Fatalf("cmd.Run() failed with %s\n", err)
    // }

    // outStr := string(stdoutBuf.Bytes())
    // fmt.Println(outStr)

    var execPath string
    var tfInstallDir string
    var err error
    tfBin := os.Getenv("terraform1")

    if len(tfBin) > 0 {
        log.Printf("Found Terraform: %s", tfBin)
        execPath = filepath.Join(tfBin, "terraform.exe")
    } else {
        log.Print("Terraform not found....installing")
        installer := &releases.ExactVersion{
            Product: product.Terraform,
            Version: version.Must(version.NewVersion("1.4.6")),
        }

        wd, _ := os.Getwd()
        tfInstallDir = filepath.Join(wd, "tf")
        if _, err := os.Stat(tfInstallDir); err != nil {
            log.Printf("Installation directory not found...creating")
            if err = os.MkdirAll(tfInstallDir, os.ModePerm); err != nil {
                log.Fatalf("ERROR: Cannot create \"%s\" directory - %v", tfInstallDir, err.Error())
                panic(err)
            }

            installer.InstallDir = tfInstallDir

            log.Printf("Installing version: %s", installer.Version.String())

            execPath, err = installer.Install(context.Background())
            if err != nil {
                log.Fatalf("Error installing Terraform: %s", err)
            }

            execPath = filepath.Join(installer.InstallDir, "terraform.exe")
            log.Printf("Installed Terraform %s at %s", installer.Version.String(), execPath)
        } else {
            execPath = filepath.Join(tfInstallDir, "terraform.exe")
            log.Printf("Terraform %s found at %s", installer.Version.String(), execPath)
        }
    }

    workingDir := "iac"
    tf, err := tfexec.NewTerraform(workingDir, execPath)
    if err != nil {
        log.Fatalf("Error running NewTerraform: %s", err)
    }

    log.Print("Start executing TF Init")
    err = tf.Init(context.Background(), tfexec.Upgrade(true))
    if err != nil {
        log.Fatalf("Error running Init: %s", err)
    }

    log.Print("Finished running TF Init")

    log.Print("Start running TF Apply")
    err = tf.Apply(context.Background())
    if err != nil {
        log.Fatalf("Error running Apply: %s", err)
    }

    log.Print("Finished running TF Apply")

    state, err := tf.Show(context.Background())
    if err != nil {
        log.Fatalf("Error running Show: %s", err)
    }

    for s, i := range state.Values.Outputs {
        val := i.Value
        if s == "tls_private_key" && i.Sensitive {
            data := val.(string)
            err := ioutil.WriteFile("propcornvm_key.key", []byte(data), 0)
            if err != nil {
                log.Fatalf("Cannot save private key to the local machine. - %s", err.Error())
            } else {
                fmt.Printf("Private Key saved: %s\n", "propcornvm_key.key")
            }
        } else {
            fmt.Printf("%s : %s", s, val)
            fmt.Println()
        }
    }
}
</pre>

<p><code>terraform-exec</code> module is used to construct the terraform commands. <a href="https://github.com/hashicorp/terraform-exec/">Take a look at its repository</a>.</p>

<p>Before you plan to use this module in your production environment, consider the below excerpt from the repository readme file:</p>

<blockquote>
<p>While terraform-exec is already widely used, please note that this module is not yet at v1.0.0, and that therefore breaking changes may occur in minor releases.</p>
</blockquote>

<p>Here is the output of the above example, when I run it with my Azure service principal.</p>

<p><img src="/images/az-tf-go-output.png" alt="Terraform automation output" /></p>

<p>You can see 1 output variable <code>public_ip_address</code> and because we have marked the other output variable as sensitive, it is not shown here in the terminal, instead its output is stored in a file named <code>popcornvm_key.key</code>.</p>

<p>We see all our resources are successfully created in Azure portal.</p>

<p><img src="/images/az-tf-result.png" alt="Azure resources created via automation" /></p>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/how-to-create-and-push-your-docker-images-to-azure-container-registry/">How to Create and Push your Docker images to Azure Container Registry</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Apr 25, 2023
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/azure">AZURE</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/docker">DOCKER</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/go">GO</a>
      
      
      
      
    </span>
    

<p><img src="/images/acr+docker-header.png" alt="Docker+Azure ACR" /></p>

<p><a href="https://hub.docker.com/">Docker Hub</a> or GitHub Container Registry also known as <a href="https://github.com/features/packages">ghcr.io</a> is a go to platform for most of the OSS developers and teams to host their Docker images. These platforms are free for open-source software, but you might need to upgrade from the free plan to use a paid plan so that your docker image is only available for your infrastructure use and not for public use.</p>

<p>Azure provides Container Registry service where you can host your Docker images with ease and use the same docker pull and run command to pull and run the container on your machine, or you can also use these images to create containers when provisioning a new Web App which uses containers or with Azure Kubernetes Service (AKS).</p>

<p>Let’s dive into how to create a simple Docker image and push it to Azure Container Registry (ACR). But before we get started, we need few things:</p>

<ul>
<li><a href="https://azure.microsoft.com/en-in/free/">Azure subscription</a></li>
<li><a href="https://docs.docker.com/get-docker/">Docker</a></li>
<li><a href="https://code.visualstudio.com/download">Visual Studio Code</a> or your favorite IDE</li>
</ul>

<h3 id="creating-azure-container-registry-in-azure"><strong>Creating Azure Container Registry in Azure</strong></h3>

<p>Go to Azure portal and click on <code>Create a resource</code> and type <code>container registry</code>. Follow the steps and you’re done.</p>

<p><img src="/images/acr-basic.png" alt="ACR Basic Tab" /></p>

<p>After the resource is created, we have to do change a few configurations to get it to work. Go to <code>Access keys</code> and enable the <code>Admin user</code>. You can now see the <code>Username</code> and 2 <code>passwords</code> which you can use to login to ACR via <code>docker login</code> command.</p>

<p><img src="/images/acr-settings.png" alt="ACR settings" /></p>

<h3 id="creating-your-docker-image"><strong>Creating your Docker Image</strong></h3>

<p>I have a small API application which I wrote in Go. It lets you fetch the lyrics of your favorite song. Here is the app in action.</p>

<p><img src="/images/goazl.png" alt="goazl in action" /></p>

<blockquote>
<p>To see it in action on your local machine, <a href="https://github.com/prashantkhandelwal/goazl">clone the repo from GitHub</a> and copy-paste this URL in your browser. <a href="http://localhost:8989/lyrics?artist=eminem&amp;song=rap%20god">http://localhost:8989/lyrics?artist=eminem&amp;song=rap%20god</a></p>
</blockquote>

<p>To create a Docker image, we first have to create a file called <code>Dockerfile</code> and then add the below docker commands.</p>

<pre class="brush: bash">
# syntax=docker/dockerfile:1 

FROM golang:1.20 

# Set destination for COPY 
WORKDIR /app 

# Download Go modules 
COPY go.mod go.sum ./ 

RUN go mod download 

COPY . ./ 

# Build 
RUN go build -o /goazl 

EXPOSE 8989 

# Run 
CMD ["/goazl"] 
</pre>

<p>Save this file and execute the command below in your terminal:</p>

<pre class="brush: bash">
$ docker build –t goazl-default .
</pre>

<p><img src="/images/docker-defaultimage.png" alt="Docker default image" /></p>

<p>The above command will take some time to execute and once it is completed successfully, you can execute another docker command to view the image it has created.</p>

<pre class="brush: bash">
$ docker images
</pre>

<p>You should always create a multi-stage docker image for your applications as it comes with some important benefits. You can read more about those benefits <a href="https://docs.docker.com/language/golang/build-images/#multi-stage-builds">here</a>.</p>

<p>Here is the multi-stage Docker file which you should use:</p>

<pre class="brush:bash">
# syntax=docker/dockerfile:1 

FROM golang:1.20 AS build-stage 

# Set destination for COPY 
WORKDIR /app 

# Download Go modules 
COPY go.mod go.sum ./ 
RUN go mod download 

COPY . ./ 

# Build 
RUN go build -o /goazl 

FROM gcr.io/distroless/base-debian11 AS release-stage 

WORKDIR /app 

COPY --from=build-stage /goazl /goazl 

EXPOSE 8989 

# Run 
ENTRYPOINT ["/goazl"] 
</pre>

<p>This time use this command to create another multi-stage docker image.</p>

<pre class="brush:bash">
$ docker build -t goazl-multistage .
</pre>

<p><img src="/images/docker-multistage.png" alt="Docker multi-stage image" /></p>

<p>You can see the difference in size of these images.</p>

<p><img src="/images/image-size-comparison.png" alt="Docker image size comparison" /></p>

<p>You can see in the above screenshot that the image with <code>default</code> in the name cost me <code>1.11GB</code> of disk space as it includes all the go tool chain. This also poses a security risk. On the other hand you can look at the size of the <code>multistage</code> docker image which is only <code>41.1MB</code>.</p>

<p>Now we have the image ready to push to ACR. Let’s configure Docker command line to use our Azure Container Registry.</p>

<h3 id="pushing-docker-image-to-acr"><strong>Pushing Docker Image to ACR</strong></h3>

<p>We will use the <code>docker login</code> command to login to the Container Registry.</p>

<pre class="brush:bash">
$ docker login ossacrprod.azurecr.io 
</pre>

<p>After this, the prompt will ask for username and password, which you can get from the Azure Portal. If all goes well then you should see something like this:</p>

<p><img src="/images/docker-login.png" alt="Docker login" /></p>

<p>With login done, we can proceed to tag our image and push it to ACR. For that, first list all the images by executing <code>docker images</code> command.</p>

<p>Tag the image with the following command:</p>

<pre class="brush:bash">
$ docker tag goazl-multistage ossacrprod.azurecr.io/goazl:1.0 
</pre>

<p>I sometimes prefer using the registry name in front of my image name, but you can also use it without it like so:</p>

<pre class="brush:bash">
$ docker tag goazl-multistage goazl:1.0 
</pre>

<p>Notice that I am using the multi-stage image as it has less storage footprint than the default image. This also lets me save some cost in terms of storage in Azure and is also quicker to pull the image from the registry. Multi-stage images let you create secure images, and it is a recommended way to create docker images.</p>

<p>The final step is to push the image to ACR using the <code>docker push</code> command:</p>

<pre class="brush:bash">
$ docker push ossacrprod.azurecr.io/goazl:1.0
</pre>

<p><img src="/images/docker-push-acr.png" alt="Docker push to ACR" /></p>

<p>You can also check your docker image in Azure Container Registry using Azure portal:</p>

<p><img src="/images/docker-image-acr.png" alt="Docker push to ACR" /></p>

<p>You can also pull this image just like any other docker image you can pull from docker hub.</p>

<pre class="brush:bash">
$ docker pull ossacrprod.azurecr.io/goazl:1.0
</pre>

<p>To make things more convenient, you can use Azure CLI to list images in your ACR. <a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli">Install az cli</a> and get started by login in using your Azure credentials. After installation is done, open terminal and issue the below command:</p>

<pre class="brush:bash">
$ az login
</pre>

<p><img src="/images/azlogin.png" alt="az login command" /></p>

<p>This command will open up your default web browser and ask for your Azure credentials. After you have successfully authenticated yourself, you can close the page. The terminal will display the list of the subscriptions you have. Depending under which subscription you have created your Azure Container Registry you should select that subscription. Here are some of the <code>az</code> commands which will help you select your subscription.</p>

<blockquote>
<p>Note that these steps are only needed if you have multiple Azure subscriptions. If you have one subscription, then you can skip these steps.</p>
</blockquote>

<p>To show which subscription is selected:</p>

<pre class="brush:bash">
$ az account show
</pre>

<p><img src="/images/azaccountshow.png" alt="az account show command" /></p>

<p>If you want to see all the subscription you have/own:</p>

<pre class="brush:bash">
$ az account list
</pre>

<p>If you want to change the default subscription used by <code>az cli</code> to be different than that of the default one, then use the below command to explicitly use that subscription:</p>

<pre class="brush:bash">
$ az account set --subscription < subscription id >
</pre>

<p>Change <code>&lt;subscription id&gt;</code> to your subscription <code>id</code> you want to use. This is the id field in the <code>az account list</code> command output.</p>

<p>After this you can verify the set subscription with the command:</p>

<pre class="brush:bash">
$ az account show
</pre>

<p>Once <code>az cli</code> is setup properly, we can now use it to list images in ACR.</p>

<p>To list images in the container registry:</p>

<pre class="brush:bash">
$ az acr repository list --name ossacrprod --output table
</pre>

<p>The above command will query the container registry and return the list of all repositories. That is what <code>acr repository list</code> is doing here. It might be possible that you have multiple ACR in your subscription, therefore, <code>--name</code> flag is used to specify the name of the registry. The <code>--output</code> flag with value table is used to output the results in <code>table</code> format.</p>

<p><img src="/images/az-acr-list.png" alt="az acr list command" /></p>

<p>To view the tags of the image in your container registry:</p>

<pre class="brush:bash">
$ az acr repository show-tags --name ossacrprod --repository goazl --output table
</pre>

<p>This command is almost the same as the previous command with slight changes to it. The initial option is set to <code>acr repository show-tags</code> instead of <code>list</code> as we want to see the tags for a given image or repository. Then we set <code>--repository</code> flag with the name of the repository (<code>goazl</code>) for which we want to see all the tags.</p>

<blockquote>
<p>All images in ACR are referred as repositories.</p>
</blockquote>

<p><img src="/images/az-acr-tag.png" alt="az acr tag command" /></p>

<h3 id="resources"><strong>Resources</strong></h3>

<ul>
<li><a href="https://docs.docker.com/desktop/install/mac-install/">Install Docker on Mac</a></li>
<li><a href="https://docs.docker.com/desktop/install/windows-install/">Install Docker on Windows</a></li>
<li><a href="https://docs.docker.com/desktop/install/linux-install/">Install Docker on Linux</a></li>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli">Install az CLI on Windows</a></li>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-linux?pivots=apt">Install az CLI on Linux</a></li>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/install-azure-cli-macos">Install az CLI on Mac</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/container-registry/">Azure Container Registry — Documentation</a></li>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI — Documentation</a></li>
<li><a href="https://docs.docker.com/language/golang/build-images/">Docker — Build Images — Documentation</a></li>
</ul>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/how-to-host-your-react-application-for-cheap-with-azure-blob-storage/">How To Host Your React Application For Cheap With Azure Blob Storage</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Apr 14, 2023
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/azure">AZURE</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/react">REACT</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/web">WEB</a>
      
      
      
      
    </span>
    

<p>If you have a static website, blog or a react application, here is how you can host them for cheap with Azure Blob Storage. This article focuses on how you can configure Azure Blob Storage to host your static website or react application.</p>

<h3 id="starting-with-create-react-app"><strong>Starting with create-react-app</strong></h3>

<p>Creating a react application is simple with <code>create-react-app</code> and then build the optimized output of the application by running <code>npm run build</code> command. This will publish the optimized version of the react app in the <code>build</code> folder.</p>

<blockquote>
<p>IMPORTANT: If you are using Next.JS or any other framework which require server-side rendering then hosting your application with Azure Blob Storage will not work as server-side rendering demands a web server to deliver the content to the client.</p>
</blockquote>

<h3 id="creating-and-configuring-azure-storage-account"><strong>Creating and Configuring Azure Storage Account</strong></h3>

<p>Once the build is completed successfully, it is time to configure Azure Blob Storage to host the static website. Go to <a href="https://portal.azure.com">portal.azure.com</a> and create a new resource by clicking <code>Create a resource</code> and then search for <code>Blob Storage</code>.</p>

<p><img src="/images/azure-blob-storage.png" alt="New resource - Azure Blob Storage" /></p>

<p>Select the resource offering which is provided by Microsoft. Click on <code>Create</code> and follow the instructions to create a new <code>Blob Storage Account</code>.</p>

<p>In the <code>Basics</code> tab, fill in the details like shown below.</p>

<p><img src="/images/blob-storage-basics.png" alt="New resource - Azure Blob Storage Basics Tab" /></p>

<p>I have created a new resource group and named it <code>staticweb</code>. You can name it anything you want. The next is <code>Storage account name</code> which you can set what you want but the name you choose here should be unique across Azure. <code>Region</code> is the place where your resources/storage account will get created. You can select the region which is close to your geographic location for lower latencies. If your website, application or blog is very critical, then you can also opt for <code>Geo-zone-redundant-storage</code> which is for critical business applications. As our use case is very simple and our application is not critical, we can select <code>Locally-redundant storage</code>. For <code>Performance</code>, you can select <code>Standard</code>, but if you want lower latencies then you can select <code>Premium</code>.</p>

<blockquote>
<p>Check pricing with <a href="https://azure.microsoft.com/en-in/pricing/calculator/">Azure Pricing Calculator</a> before you proceed with any service in Azure. This will give you an idea of how much money you have to spend with these settings over a period of a month.</p>
</blockquote>

<p>Let’s keep all other settings as they are and click <code>Create</code> to provision a new Storage Account.</p>

<p><img src="/images/blob-storage-review-create.png" alt="New resource - Azure Blob Storage review and create" /></p>

<p>After the storage account is created, under <code>Data management</code>, select <code>Static website</code>.</p>

<p><img src="/images/azure-storage-static-website.png" alt="Azure Blob Storage static website" /></p>

<p>Static websites are disabled by default. Click on <code>Enabled</code> and you will see two fields are now visible asking for the index document name and error document path.</p>

<p><img src="/images/static-website-enabled.png" alt="Static website enabled" /></p>

<p>Depending on the landing, default or index page of your application, you can enter the name of the document here. In my case where I am hosting a react application, the index document name is <code>index.html</code> and error document can be <code>404.html</code> or something else. I don’t have an error document, so I am leaving it blank.</p>

<p>Click <code>Save</code> to save the setting. You will now have the URL of your static website along with the name of the container where the contents of your static app should be uploaded.</p>

<p><img src="/images/static-website-url.png" alt="Static website url" /></p>

<p>Notice the container name is <code>$web</code> and the primary endpoint is <a href="https://myawesomewebsite.z13.web.core.windows.net/">https://myawesomewebsite.z13.web.core.windows.net/</a>.</p>

<p>You can also navigate to this <code>$web</code> container by clicking <code>Containers</code> under <code>Data storage</code> section.</p>

<p><img src="/images/static-website-containers.png" alt="Static website container" /></p>

<h3 id="upload-static-contents-of-web-app"><strong>Upload static contents of web app</strong></h3>

<p>Uploading multiple files directly from the portal is a tedious task and takes a lot of time. I would recommend making use of an open-source tool called <a href="https://azure.microsoft.com/en-us/products/storage/storage-explorer">Azure Storage Explorer</a>. Download this for your operating system and install it.</p>

<p><img src="/images/azure-storage-explorer.png" alt="Azure storage explorer" /></p>

<p>There are a few ways to connect to the storage account in Storage Explorer.</p>

<ul>
<li>Sign in with your Azure credentials and connect to all the storage accounts you have in your subscription.</li>
<li>Use storage account connection string to connect to a specific storage account.</li>
</ul>

<p>Click on <code>Attach a resource</code> on the <code>Get Started</code> page or right click <code>Storage Account</code> and select <code>Connect to Azure storage…</code></p>

<p><img src="/images/storage-explorer-select-resource.png" alt="Azure storage explorer - Select Resource" /></p>

<p>You can also select <code>Blob container</code> and then generate the <code>SAS token</code> to connect to a container. I am connecting my storage account with storage account connection string. You can get the connection string from the Azure Portal.</p>

<p><img src="/images/storage-access-keys.png" alt="Storage account access keys" /></p>

<p>Under <code>Security + Networking</code>, click <code>Access Keys</code> and then click on <code>Show</code> button for <code>Key1 &gt; Connection string</code>. Click <code>Copy to clipboard</code> icon to copy the connection string.</p>

<p>Back in the Storage Explorer, click on <code>Connection string (Key or SAS)</code>.</p>

<p><img src="/images/storage-explorer-connection-method.png" alt="Storage explorer - connection method" /></p>

<p>Enter the connection information and click <code>Next</code>.</p>

<p><img src="/images/storage-explorer-connection-info.png" alt="Storage explorer - connection info" /></p>

<p><img src="/images/storage-explorer-summary.png" alt="Storage explorer - summary" /></p>

<p>Review the final details and click on <code>Connect</code> to connect to the storage account.</p>

<p>After the connection is succeeded, you should see the list of all the containers in the storage account.</p>

<p><img src="/images/storage-explorer-container-view.png" alt="Storage explorer - Container view" /></p>

<p>Select the <code>$web</code> container and start uploading the files of your static web app.</p>

<p><img src="/images/react-build-app.png" alt="React build app output" /></p>

<p><img src="/images/storage-explorer-files-uploaded.png" alt="Storage explorer - Uploaded contents" /></p>

<p>That’s all!!</p>

<p>Let’s check if our react application is running through static website blob storage url or not.</p>

<p>I built my react application by using the <code>npm run build</code> command and these are the files which I am going to upload to the <code>$web</code> container.</p>

<p><img src="/images/static-website-final-result.png" alt="Static Website - Final Result" /></p>

<p>Hooray!! Our react application is successfully hosted and served from Azure Blob Storage.</p>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/capture-screenshot-and-description-of-a-web-page-using-go-and-chromedp/">Capture screenshot and description of a web page using Go and Chromedp</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Apr 5, 2023
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/chromedp">CHROMEDP</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/go">GO</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/web">WEB</a>
      
      
      
      
    </span>
    <p>Adding or sharing a link with a snapshot of a web page is a very useful feature in Microsoft Teams or in Zoom chat. This gives a user a way to quickly look at the web page snapshot and a small description about the link.</p>

<p>Go has an amazing library called <a href="https://github.com/chromedp/chromedp">chromedp</a> which allows you to perform some amazing tasks like taking screenshot, fill out a form and submit it, send key events, device emulation, script evaluation etc. You can look at the complete example list <a href="https://github.com/chromedp/examples">here</a>.</p>

<p>We are interested in taking a screenshot of the web page for the given URL. Chromedp allows you the take a screenshot of a specific element of the page or for the entire browser viewport.</p>

<p>The use case I am having is to capture just enough of the web page to give an idea to the user about the website. Looking at the screenshot and recalling whether one has visited this link or not is easier than looking at the link. Here is a sample code which will let you snap a screenshot of a given web page.</p>

<pre class="brush:ruby">
package main

import (
 "context"
 "crypto/rand"
 "fmt"
 "log"
 "os"
 "time"
 "unsafe"

 "github.com/chromedp/cdproto/emulation"
 "github.com/chromedp/chromedp"
)

const (
 UserAgentName = "Websnapv1.0"
 Path          = "images\\"
 Timeout       = 15
)

// https://stackoverflow.com/questions/22892120/how-to-generate-a-random-string-of-a-fixed-length-in-go
func GenRandStr(n int) string {
 var alphabet = []byte("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")
 b := make([]byte, n)
 rand.Read(b)
 for i := 0; i < n; i++ {
  b[i] = alphabet[b[i]%byte(len(alphabet))]
 }
 return *(*string)(unsafe.Pointer(&b))
}

func Snap(url string) (string, error) {
 ctx, cancel := chromedp.NewContext(context.Background())
 defer cancel()

 // Creating timeout for 15 seconds
 ctx, cancel = context.WithTimeout(ctx, time.Second*Timeout)
 defer cancel()

 name := GenRandStr(12)
 var buf []byte
 var file = Path + name + ".png"

 err := chromedp.Run(ctx,
  emulation.SetUserAgentOverride(UserAgentName),
  chromedp.Navigate(url),
  //chromedp.FullScreenshot(&buf, 100),
  chromedp.CaptureScreenshot(&buf),
 )

 if err != nil {
  log.Fatalf("ERROR:webext - Unable to extract meta(s) from the given URL - %s\n", url)
  return "", err
 }

 if err := os.WriteFile(file, buf, 0o644); err != nil {
  log.Fatalf("ERROR:webext - Cannot create snap for the link - %s\n", url)
  file = ""
  return "", err
 }

 return file, nil
}

func main() {
 i, err := Snap("https://medium.com/@prashantkhandelwal/marvel-comics-universe-graph-database-7264381478e1")
 if err != nil {
  log.Fatalf("ERROR: Unable to retrieve screenshot - %v", err.Error())
 }

 // print the image path
 fmt.Println(i)
}
</pre>

<p>Here, I have some <code>const</code> declared which are easy to understand. Then I have a random string generator which I found on Stackoverflow to generate random image names. In the end I have a function <code>snap</code> which takes a screenshot of the web page. Overall, this function is very simple to understand but I want you to pay special attention to this part of the function where <code>chromedp</code> is used.</p>

<pre class="brush:ruby">
err := chromedp.Run(ctx, 
  emulation.SetUserAgentOverride("Bindv1.0"), 
  chromedp.Navigate(url), 
  chromedp.CaptureScreenshot(&buf), 
 ) 
</pre>

<p>Now the <code>CaptureScreenshot</code> is a function which will capture a part of the web page. This function accepts the pointer to the buffer to which it writes the output eventually writes to an image file. Here is an example output:</p>

<p><img src="/images/screenshot-web-page-1.png" alt="Screenshot from `CaptureScreenshot` function" /></p>

<p>The next useful function that you can also use is called <code>FullScreenshot</code>. This function will let you capture the entire web page as an image. You can use this function with your functional tests to check how your web page looks when accessed from a different location or with different parameters. This function takes two parameters, the first is the pointer to the buffer, just like the one before and the second one is the <code>quality</code> of the image. As the screenshot is for the entire viewport or the web page, I am uploading an image displayed in an image viewer program to give you a perspective of the screenshot. Here is an example output:</p>

<p><img src="/images/Screenshot-full-viewport.png" alt="Screenshot from `FullScreenshot` function" /></p>

<p>With screenshots done, let’s also get some basic information about the web page as well. Let’s create a new method and name it <code>ExtractMeta</code>. It accepts URL of the web page as a parameter and returns a pointer to the <code>WebData</code> struct which holds value for <code>Title</code> and <code>Description</code> of the web page. This function looks exactly like the <code>Snap</code> function except for a slight change in the Run function usage and some variable declarations to hold returned values. Here is the code for extracting the metadata information:</p>

<pre class="brush:ruby">
var pageTitle, description string

var w = &WebData{}

err := chromedp.Run(ctx,
 emulation.SetUserAgentOverride(UserAgentName),
 chromedp.Navigate(url),
 chromedp.Title(&pageTitle),
 chromedp.Evaluate(`document.querySelector("meta[name^='description' i]").getAttribute('content');`, &description),
)

w.Title = pageTitle
w.Description = description
</pre>

<p>Notice that the <code>Run</code> function has additional parameters <code>chromedp.Evaluate</code> and <code>chromedp.Title</code>. The <code>chromedp.Title</code> returns the title of the web page. The <code>chromedp.Evaluate</code> function lets you evaluate or execute a <code>JavaScript</code> on the web page it is visiting and return the result so you can use it. For our use case, which is to get the description of the web page, we can execute the <code>document.querySelector</code> on the <code>meta</code> tags of the web page where the meta tag <code>name</code> equals to <code>description</code>. The <code>i</code> is the case-insensitivity qualifier here. Add the below code to the <code>main</code> function:</p>

<pre class="brush:ruby">
w, err := ExtractMeta("https://medium.com/@prashantkhandelwal/marvel-comics-universe-graph-database-7264381478e1")
if err != nil {
 log.Fatalf("ERROR: Unable to retrieve metadata - %v", err.Error())
}
fmt.Println(w.Title)
fmt.Println(w.Description)
</pre>

<p>Executing above code will generate the output like this:</p>

<p><img src="/images/final-output.png" alt="Final output of the entire program" /></p>

<p>Similarly, you can also execute this function multiple times to get other information from the web page as desired.</p>

<p>Here is the complete code for reference:</p>

<pre class="brush:ruby">
package main

import (
    "context"
    "crypto/rand"
    "fmt"
    "log"
    "os"
    "time"
    "unsafe"

    "github.com/chromedp/cdproto/emulation"
    "github.com/chromedp/chromedp"
)

const (
    UserAgentName = "Websnapv1.0"
    Path          = "images\\"
    Timeout       = 15
)

type WebData struct {
    Title       string
    Description string
}

// https://stackoverflow.com/questions/22892120/how-to-generate-a-random-string-of-a-fixed-length-in-go
func GenRandStr(n int) string {
    var alphabet = []byte("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ")
    b := make([]byte, n)
    rand.Read(b)
    for i := 0; i < n; i++ {
        b[i] = alphabet[b[i]%byte(len(alphabet))]
    }
    return *(*string)(unsafe.Pointer(&b))
}

func Snap(url string) (string, error) {
    ctx, cancel := chromedp.NewContext(context.Background())
    defer cancel()

    // Creating timeout for 15 seconds
    ctx, cancel = context.WithTimeout(ctx, time.Second*Timeout)
    defer cancel()

    name := GenRandStr(12)
    var buf []byte
    var file = Path + name + ".png"

    err := chromedp.Run(ctx,
        emulation.SetUserAgentOverride(UserAgentName),
        chromedp.Navigate(url),
        //chromedp.FullScreenshot(&buf, 100),
        chromedp.CaptureScreenshot(&buf),
    )

    if err != nil {
        log.Fatalf("ERROR:webext - Unable to extract meta(s) from the given URL - %s\n", url)
        return "", err
    }

    if err := os.WriteFile(file, buf, 0o644); err != nil {
        log.Fatalf("ERROR:webext - Cannot create snap for the link - %s\n", url)
        file = ""
        return "", err
    }

    return file, nil
}

func ExtractMeta(url string) (*WebData, error) {
    ctx, cancel := chromedp.NewContext(context.Background())
    defer cancel()

    // Creating timeout for 15 seconds
    ctx, cancel = context.WithTimeout(ctx, time.Second*Timeout)
    defer cancel()

    var pageTitle, description string

    var w = &WebData{}

    err := chromedp.Run(ctx,
        emulation.SetUserAgentOverride(UserAgentName),
        chromedp.Navigate(url),
        chromedp.Title(&pageTitle),
        chromedp.Evaluate(`document.querySelector("meta[name^='description' i]").getAttribute('content');`, &description),
    )

    if err != nil {
        log.Fatalf("ERROR:webext - Unable to extract meta(s) from the given URL - %s\n", url)
        return nil, err
    }

    w.Title = pageTitle
    w.Description = description

    return w, nil
}

func main() {
    i, err := Snap("https://medium.com/@prashantkhandelwal/marvel-comics-universe-graph-database-7264381478e1")
    if err != nil {
        log.Fatalf("ERROR: Unable to retrieve screenshot - %v", err.Error())
    }

    // print the image path
    fmt.Println(i)

    // Extract metadata of the page
    w, err := ExtractMeta("https://medium.com/@prashantkhandelwal/marvel-comics-universe-graph-database-7264381478e1")
    if err != nil {
        log.Fatalf("ERROR: Unable to retrieve metadata - %v", err.Error())
    }
    fmt.Println(w.Title)
    fmt.Println(w.Description)
}
</pre>

<p><strong>References</strong></p>

<ul>
<li><a href="https://github.com/chromedp/chromedp">Chromedp GitHub Repository</a></li>
<li><a href="https://github.com/chromedp/examples">Chromedp Examples GitHub Repository</a></li>
</ul>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/marvel-comics-universe-graph-db/">Marvel Comics Universe Graph Database</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Jan 3, 2023
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/.net">.NET</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/c">C#</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/database">DATABASE</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/graph">GRAPH</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/gremlin">GREMLIN</a>
      
      
      
      
    </span>
    <p>In the past decade Marvel has gathered a lot of fans following which eventually led all the fans to know more about how the Marvel comics universe characters, stories, events are mapped or linked to each other.</p>

<p>In 2017 (if I am remembering it correctly), at Microsoft Build event, Microsoft announces Bot framework and did a demo with CosmosDB graph database which uses Gremlin query from <a href="https://tinkerpop.apache.org/">Apache TinkerPop</a>. It was a great demo, and I was really impressed by how they did it but unfortunately, I was unable to find the source code for that demo anywhere. So, I thought I should at least get the graph database for my own use and then sometime later will work on building a NLU bot.</p>

<p>To get started I will be setting up the database using Apache TinkerPop and not CosmosDB due to cost and development speed. Will make use of <a href="https://github.com/apache/tinkerpop/tree/master/gremlin-dotnet">Gremlin.NET</a> - a wrapper around Gremlin Query Language. Let&rsquo;s <a href="https://tinkerpop.apache.org/download.html">download Apache TinkerPop Gremlin Server and Console</a>. These will be downloaded in .zip file, so extract them into a folder and navigate to the <code>bin</code> directory inside each extracted folder and using the command/shell prompt execute the <code>.bat</code> file if you&rsquo;re on Windows else <code>.sh</code> file if you are on Linux or WSL on Windows.</p>

<p><img src="/images/gremlin-server-start.png" alt="Gremlin Server Start" />
<img src="/images/gremlin-console-start.png" alt="Gremlin Console Start" /></p>

<p>After both the server and console are running, go to console terminal window and connect to the local TinkerPop server. Note that the console is independent of the server running on the local machine. If you are assuming that it will automatically connect to the running local instance of the server, then you are wrong. Therefore, we have to connect to the local server instance by executing the below command in the Gremlin console.</p>

<pre class="brush: shell">
gremlin> :remote connect tinkerpop.server conf/remote.yaml session
</pre>

<p>If you are unable to connect to the local server instance, then it might be a problem with your config file (.yaml) which you can find under <code>conf</code> folder in your <code>console</code> folder. Here are the contents of my <code>remote.yaml</code> file.</p>

<pre class="brush: text">
hosts: [localhost]
port: 8182
serializer: { className: org.apache.tinkerpop.gremlin.driver.ser.GraphBinaryMessageSerializerV1, config: { serializeResultToString: true }}
</pre>

<p>With connection established, now we can import the <code>graphson</code> data in the database. You can also refer to my <a href="https://github.com/prashantkhandelwal/mcugraph">Github repo</a> where I have used the raw data from the web to generate the edges and vertices for all Marvel characters. The <a href="https://syntagmatic.github.io/marvel/data/hero-network.csv">raw data</a> which is in csv format has some repetitive connections. The repo code ensures that there are no duplicate connections. You can also refer to the code if you plan to connect and play with TinkerPop graph database. Running the code and setting up the database will be a bit time-consuming, so I would suggest to download the <code>mcu.json</code> file from the repo and then importing it, which will happen in a few seconds.</p>

<p>The data file which you downloaded from the repo <code>mcu.json</code> should be stored on the Gremlin server current working directory. After you place the file, execute the below command on the Gremlin console.</p>

<pre class="brush: shell">
gremlin> :> g.io("mcu.json").read().iterate()
</pre>

<p>The above command will take a few seconds to execute and then it will return you back to the <code>gremlin</code> console. We can now verify the data by executing this command.</p>

<pre class="brush: shell">
gremlin> :> graph
</pre>

<p>If all goes well, you should see the output below of the above command.</p>

<p><img src="/images/gremlin-marvel-data-stats.png" alt="Gremlin marvel database stats" /></p>

<p>Let&rsquo;s write some Gremlin queries and find out some information. Go to Gremlin console and test these below queries.</p>

<p>How many people does Cap know?</p>

<pre class="brush: shell">
gremlin> :> g.V().has("name","CAPTAIN AMERICA").outE("knows").count()
</pre>

<p>And who are those people?</p>

<pre class="brush: shell">
gremlin> :> g.V().has("name","CAPTAIN AMERICA").out("knows").values("name")
</pre>

<p>Characters who have <code>IRON</code> in their name. Note that this is case-sensitive.</p>

<pre class="brush: shell">
gremlin> :> g.V().has('name', containing('IRON')).values('name')
</pre>

<p>As this is a graph database, it will be nice if we can visualize the data visually. There are few visualization tools I have used so far and <a href="https://gdotv.com/">GDotV</a> seems to a be popular one.</p>

<p><img src="/images/gremlin-gdotv-explorer.png" alt="GDotV Greamlin Visualization Tool" /></p>

<p>You can also visualize using this simple open-source graph visualization tool called <a href="https://github.com/prabushitha/gremlin-visualizer">gremlin-visualizer</a>. There are other visualization tools as well in case you want to work with some advanced feature sets. I personally make use of the basic console and mix of <code>gdotv</code> <code>gremlin-visualizer</code> as it fits my needs. For example, you will be able to execute this query below and see the visualization in <code>gremlin-visualizer</code> but unable to get this query to execute in <code>gdotv</code> version 1.0.1.</p>

<pre class="brush: shell">
g.V().has('hero', 'id', "CAPTAIN AMERICA").outE("knows").inV()
</pre>

<p><img src="/images/gremlin-visualizer-ui.png" alt="Gremlin-Visualizer - Visualization Tool" /></p>

<p><strong>Reference &amp; Resources</strong></p>

<ul>
<li><a href="https://github.com/prashantkhandelwal/mcugraph/">Github - mcugraph</a></li>
<li><a href="https://github.com/apache/tinkerpop/tree/master/gremlin-dotnet">Github - Gremlin.NET</a></li>
<li><a href="https://github.com/prabushitha/gremlin-visualizer">Github - gremlin-visualizer</a></li>
<li><a href="https://kelvinlawrence.net/book/Gremlin-Graph-Guide.html">Kelvin Lawrence Book - Practical Gremlin</a></li>
<li><a href="https://tinkerpop.apache.org/docs/current/tutorials/getting-started/">Apache TinkerPop - Getting Started</a></li>
</ul>

  </div>
  
</div>


<ul class="pagination">
    
    <li class="page-item">
        <a href="/" class="page-link" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li class="page-item disabled">
    <a href="" class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item active"><a class="page-link" href="/">1</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/2/">2</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/3/">3</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item disabled"><span aria-hidden="true">&nbsp;&hellip;&nbsp;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/33/">33</a></li>
    
    
    <li class="page-item">
    <a href="/page/2/" class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li class="page-item">
        <a href="/page/33/" class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>


        </div>
        



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-QYXJT2TJCG', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>

<link
  href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shCore.min.css"
  rel="stylesheet"
/>
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeDefault.min.css"
  rel="stylesheet"
/>

<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shCore.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCSharp.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCss.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushJScript.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPlain.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushSql.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushXml.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPowerShell.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPython.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushBash.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCpp.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushRuby.min.js"
></script>

<script>
  SyntaxHighlighter.defaults["gutter"] = true;
  SyntaxHighlighter.defaults["smart-tabs"] = true;
  SyntaxHighlighter.defaults["auto-links"] = true;
  SyntaxHighlighter.defaults["collapse"] = false;
  SyntaxHighlighter.defaults["light"] = false;
  SyntaxHighlighter.defaults["tab-size"] = 4;
  SyntaxHighlighter.defaults["toolbar"] = false;
  SyntaxHighlighter.defaults["wrap-lines"] = true;
  SyntaxHighlighter.all();
</script>


    </body>
</html>
