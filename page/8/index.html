<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.49" />

    

<title>Midnight Programmer</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Midnight Programmer"/>
<meta name="twitter:description" content="Programming For Fun"/>

<meta property="og:title" content="Midnight Programmer" />
<meta property="og:description" content="Programming For Fun" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://prashantkhandelwal.github.io/" />
<meta property="og:updated_time" content="2013-06-19T20:28:00&#43;00:00"/><meta property="og:site_name" content="Midnight Programmer" />


    


<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/print.css" media="print">


    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

<link href="https://prashantkhandelwal.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Midnight Programmer" />
<link href="https://prashantkhandelwal.github.io/index.xml" rel="feed" type="application/rss+xml" title="Midnight Programmer" />


</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://prashantkhandelwal.github.io/">Midnight Programmer</a>
      </span>
      
      
      
      <div class="author-image">
        <img src="https://prashantkhandelwal.github.io//img/prashantk.jpg" alt="Author Image" class="img--circle img--headshot element--center"> 
      </div>
      
      <p class="site__description">
         Programming For Fun 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Midnight Programmer</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/archive/"><i class='fa fa-road'></i>
						<span>Archive</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/top-posts/"><i class='fa fa-star fa-fw'></i>
						<span>Top Posts</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/contact/"><i class='fa fa-envelope fa-fw'></i>
						<span>Contact</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	
	<a href="https://facebook.com/khandelwal.p" rel="me"><i class="fab fa-facebook-f"></i></a>
	
	
	<a href="https://github.com/prashantkhandelwal" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="http://feeds.feedburner.com/MidnightProgrammer" rel="me"><i class="fa fa-rss fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://instagram.com/prashantkhandelwal" rel="me"><i class="fab fa-instagram fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://linkedin.com/in/khandelwalprashant" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://medium.com/@prashantkhandelwal" rel="me"><i class="fab fa-medium fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://mastodon.social/@prashantkhandelwal" rel="me"><i class="fab fa-mastodon fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
</section>

      </div>
    </div>
    <p class="copyright">
      &copy; 2023 Pashant Khandelwal
      <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/2.5/in/"><img style="border-width: 0;" src="https://i.creativecommons.org/l/by-nc-sa/2.5/in/88x31.png" alt="Creative Commons License" class="thinglinkFiltered"></a>
      
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            
<div class="post-list">
  
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/dev-buzz-1-bookmarks-19-jun-2013/">Dev Buzz #1 - Bookmarks - 19 JUN 2013</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Jun 19, 2013
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/devbuzz">DEVBUZZ</a>
      
      
      
      
    </span>
    

<div style="text-align: -webkit-center;">
<img src="/images/devbuzz3.jpg" alt="Devbuzz Image" />
</div>

<h4 id="asp-net-mvc-web">ASP.NET/MVC/Web</h4>

<ul>
<li><a href="http://dotnet.dzone.com/articles/four-new-single-page?mz=57923-dotnet">4 new single page application templates</a></li>
<li><a href="http://typecastexception.com/post/2013/04/14/Deploying-an-Azure-Website-from-Source-Control.aspx">Deploying an Azure website from Source Control</a></li>
<li><a href="http://tech.pro/tutorial/1186/collaborative-route-planner-with-signalr-knockoutjs-and-google-maps">Collaborative route planner with SignalR, Knockout.JS and Google Maps</a></li>
<li><a href="http://tech.pro/tutorial/1156/using-requirejs-in-an-aspnet-mvc-application">Using Require.JS in an ASP.NET MVC application</a></li>
<li><a href="http://www.simpleprogrammer.com/2013/05/19/glimpse/">Getting started with Glimpse in ASP.NET MVC</a></li>
<li><a href="http://www.adamtibi.net/06-2013/five-essential-front-end-tools-that-should-be-used-with-modern-mvc-projects">Five essential front-end tools that should be used with modern MVC projects</a></li>
</ul>

<h4 id="jquery">JQuery</h4>

<ul>
<li><a href="http://keithcirkel.co.uk/jwerty/">JWERTY</a> – Awesome handling of keyboard events</li>
<li><a href="http://www.justgage.com/">JustGage</a> - JustGage is a handy JavaScript plugin for generating and animating nice &amp; clean gauges</li>
<li><a href="http://www.spritely.net/gallery/">Spritely.NET</a> – Best parallax plugin for jQuery</li>
<li><a href="http://jamielottering.github.io/DropKick/">DropKick</a> – A jquery plugin for beautiful dropdowns</li>
<li><a href="http://onehackoranother.com/projects/jquery/tipsy/">Tipsy</a> – Facebook-style tooltip plugin for jQuery</li>
</ul>

<h4 id="visual-studio">Visual Studio</h4>

<ul>
<li><a href="http://visualstudiogallery.msdn.microsoft.com/33b0242d-7158-4d39-9a01-0a08cf7c28bd">Farticus</a> – When a build fails, it plays the fart sound</li>
<li><a href="http://visualstudiogallery.msdn.microsoft.com/ce35c120-405a-435b-af2a-52ff24eb2c30">Voice Commands</a> – Control Visual Studio with your voice</li>
<li><a href="http://visualstudiogallery.msdn.microsoft.com/366ad100-0003-4c9a-81a8-337d4e7ace05">Color Theme Editor</a> – Visual Studio 2012 Color Theme Editor</li>
<li><a href="http://www.johnpapa.net/zen-coding-in-visual-studio-2012/">Zen Coding in Visual Studio 2012</a></li>
</ul>

<h4 id="open-source">Open Source</h4>

<ul>
<li><a href="https://www.codeplex.com/site/users/view/win8templates">Windows 8 App design templates</a> - More than 70 app design templates</li>
<li><a href="http://mahapps.com/MahApps.Metro/">MahApps</a> – Make your WPF app look like Windows 8 app</li>
<li><a href="https://mui.codeplex.com/">MUI</a> – Build Win8 like apps using this library in WPF</li>
<li><a href="https://modernuicharts.codeplex.com/">ModerUICharts</a> – Modern UI (Metro) Charts for Windows 8, WPF, Silverlight</li>
<li><a href="https://code.google.com/p/dapper-dot-net/">Dapper</a> – A simple object mapper in .NET – Micro ORM</li>
<li><a href="http://miniprofiler.com/">Mini-Profiler</a> – A simple but effective min-profiler for .NET &amp; Ruby</li>
</ul>

<h4 id="misc">Misc</h4>

<ul>
<li><a href="https://code.google.com/p/zen-coding/">ZenCoding</a> - A new way of writing HTML and CSS</li>
<li><a href="http://client.cors-api.appspot.com/client">CORS Test</a> – Use this page to test CORS requests</li>
<li><a href="http://json2csharp.com/">JSON2Csharp</a> – Generate C# classes from JSON</li>
<li><a href="http://en.wikipedia.org/wiki/User:Svick/LinqToWiki">LINQtoWiki</a> – Library for accessing MediaWiki wikis (including Wikipedia) (<a href="https://github.com/svick/LINQ-to-Wiki">Source</a>)</li>
<li><a href="http://modernuiicons.com/">ModernUIIcons</a> - Set of awesome icons for WP8 and Win8</li>
</ul>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/developer-buzz-dev-buzz-sharing-my-bookmarks/">Developer Buzz (Dev Buzz) - Sharing My Bookmarks</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Jun 16, 2013
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/devbuzz">DEVBUZZ</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/musings">MUSINGS</a>
      
      
      
      
    </span>
    <p>Dev Buzz is an abbreviated form of Developer Buzz which will be a carrier of my bookmarks. There is no point of saving me a bookmark if I can’t share out with other developers (this is my thought on bookmarks). Therefore, from today onward I’ll be doing a blog post week or may be monthly to share by bookmark with the rest of you guys and moreover I have a huge collection of funny programmer pics which also accompany my bookmarks. Hope you all like this.</p>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/html5-video-capture-and-upload-image-to-azure-storage/">HTML5 Video - Capture And Upload Image To Azure Storage</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Jun 2, 2013
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/asp.net">ASP.NET</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/azure">AZURE</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/cloud">CLOUD</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/html5">HTML5</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/web">WEB</a>
      
      
      
      
    </span>
    

<p>I was exploring Github for some image effects/filters and I found some but still keep exploring and found an interesting plugin called <a href="https://github.com/neave/face-detection">face-detection</a>. This plugin uses HTML5 <a href="http://www.html5rocks.com/en/tutorials/getusermedia/intro/">getUserMedia</a> to use your web camera only if your browser supports it. Unfortunately, IE10 still doesn’t support it. This seems cool to me, so I created a sample application to test it. This sample application will let you preview the video using your web camera and allows you to capture the image from your web camera and upload  it to the Azure storage. The javascript code for the HTML5 video I am using is from David Walsh’s <a href="http://davidwalsh.name/browser-camera">post</a>. Not every browser supports getUserMedia, so if the user is not using the browser which supports getUserMedia then you can show an alert message to the user notifying about the browser incompatibility. Here is the function which will check your browser compatibility for getUserMedia.</p>

<pre class="brush: jscript">
function hasGetUserMedia() {
 // Note: Opera is unprefixed.
 return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
 navigator.mozGetUserMedia || navigator.msGetUserMedia);
}
  
if (hasGetUserMedia()) {
 // Good to go!
} else {
 alert('getUserMedia() is not supported in your browser');
}
</pre>

<p>To know more and explore more what you can do with getUserMedia visit <a href="http://www.html5rocks.com/en/tutorials/getusermedia/intro/">HTML5Rocks</a>. Moving further, I have a normal HTML page where initially I am placing 3 elements on the page. One is a video tag which will show the stream from the web camera attached to your machine or your laptop camera. Second, is the canvas tag which is used to show the image captured from the web camera and the third one is the normal button which will let me capture the image at my will on its click.</p>

<pre class="brush: html">
<video autoplay id="video" width="640" height="480"></video>
<input id="snap" type="button" value="Click" />
<canvas id="canvas" width="640" height="480"></canvas>
</pre>

<p>Notice the <code>autoplay</code> property in the video tag. I have set it because I don’t want the video to be frozen as soon as it started. To make the video work I am using David Walsh’s code as it is without any changes.</p>

<pre class="brush: jscript">
window.addEventListener("DOMContentLoaded", function () {
    // Grab elements, create settings, etc.
    var canvas = document.getElementById("canvas"),
        context = canvas.getContext("2d"),
        video = document.getElementById("video"),
        videoObj = { "video": true },
        errBack = function (error) {
            console.log("Video capture error: ", error.code);
        };
  
    if (navigator.getUserMedia) { // Standard
        navigator.getUserMedia(videoObj, function (stream) {
            video.src = stream;
            video.play();
        }, errBack);
    } else if (navigator.webkitGetUserMedia) { // WebKit-prefixed
        navigator.webkitGetUserMedia(videoObj, function (stream) {
            video.src = window.webkitURL.createObjectURL(stream);
            video.play();
        }, errBack);
    }
  
    // Trigger photo take
    document.getElementById("snap").addEventListener("click", function () {
        context.drawImage(video, 0, 0, 640, 480);
    });
}, false);
</pre>

<p>In the above script, you can see that it first checks if the browser or navigator has the getUserMedia support. if you see there are two conditions one for the standard and other one with the webkit prefix. In the end, the click event on the button which will let me capture the image.</p>

<p>When you view the application in the browser, the browser will prompt you whether you want to allow or deny the application to use the web camera.</p>

<p><img src="/images/azure-camera-access.png" alt="Allow camera access in browser" /></p>

<p>You cannot run this just by double-clicking the file due to security reasons. You must access the web page from the server itself, either from within the Visual Studio development server, from IIS or by publishing the file on your production server. It can be annoying for many users to grant the access to the camera every time they access the page. You can save the user consent if you are using https. If you plan to stick with http, you will not be able to do this.</p>

<p>Looking in the address bar again, you will notice that the fav icon of the web application, changed to an animated icon. It is a little red dot which keeps on flashing notifying the user that the camera is in use. If you plan to block the access to the camera permanently or temporarily, you can then click the camera icon which is on the right hand side of the address bar.</p>

<p><img src="/images/azure-camera-mic-access.png" alt="Camera and mic access in browser" /></p>

<p>When you click the icon you will be prompted with options to continue allow the access to the camera or always block the camera. Also if you notice the camera option, you will see that it is showing me two devices or camera attached to the machine. I build this application on my laptop so I am able to the integrated camera which is the front facing camera of my laptop and the second one is the USB camera I have plugged on my laptop’s USB port. I can choose to use any one of these. If you make any changes to these settings and click on done, you will be asked to reload the page.</p>

<p>This is how my web page looks.</p>

<p><img src="/images/azure-web-page-cam.png" alt="Web app" /></p>

<p>The click button is at the bottom right hand side will let me take a snap of the feed coming from my camera. When I click the Click button, the image is captured and show on the canvas we have added on the page. This is my web page after I took the snap from my web camera.</p>

<p><img src="/images/azure-webapp-cam-snap.png" alt="Web app camera snap" /></p>

<p>The second image (at the bottom) is the image on the canvas that is snapped from the camera. Now I want to upload the image to my Azure cloud storage. If you look at the address bar, you’ll notice that I have used normal HTML page. It’s you wish if you want to use a simple HTML page or a web form. Both works good. The problem I am going to face with web forms is if I am going to upload the snapped image to my cloud storage or to my server repository, the page will post-back which is not cool at all. So I am going to accomplish it by making an AJAX call. Add a HTML button to your page and on its click event upload the file to the cloud.</p>

<p>I have the image on my canvas, therefore you just cannot retrieve the image Base64 string just like that. I am going to extract the <a href="https://en.wikipedia.org/wiki/Base64">Base64</a> string of the image from the canvas and pass it as a parameter. The server method will then convert the Base64 string to stream and upload it to the cloud storage. Here is the jQuery AJAX call.</p>

<pre class="brush: jscript">
function UploadToCloud() {
    $("#upload").attr('disabled', 'disabled');
    $("#upload").attr("value", "Uploading...");
    var img = canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
    $.ajax({
        url: "Camera.aspx/Upload",
        type: "POST",
        data: "{ 'image': '" + img + "' }",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function () {
            alert('Image Uploaded!!');
            $("#upload").removeAttr('disabled');
            $("#upload").attr("value", "Upload");
        },
        error: function () {
            alert("There was some error while uploading Image");
            $("#upload").removeAttr('disabled');
            $("#upload").attr("value", "Upload");
        }
    });
}
</pre>

<p>The line 4 in the above script is the one which will get the Base64 string of the image from the canvas. The string is now in the variable named img which I am passing as a parameter to the <code>Upload</code> web method in my code-behind page. You can use web service or handler or maybe a WCF service to handle the request but I am sticking with page methods. Before you can actually make use of the Azure storage, you have to add reference of the <a href="http://nuget.org/packages/WindowsAzure.Storage/">Azure Storage library from NuGet</a>. Fire the below NuGet command to add the Azure Storage reference to your application.</p>

<pre class="brush: shell">
PM> Install-Package WindowsAzure.Storage
</pre>

<p>After the package/assemblies are referenced in your code, add the below namespaces.</p>

<pre class="brush: csharp">
using Microsoft.WindowsAzure.Storage;
using Microsoft.WindowsAzure.Storage.Blob;
using Microsoft.WindowsAzure.Storage.Auth;
using System.IO; //For MemoryStream
using System.Web.Services; //For WebMethod attribute
</pre>

<p>These all the namespace will help me to connect to my local cloud storage emulator or to my live cloud storage. This is my upload method which will upload the file to my live cloud storage.</p>

<pre class="brush: csharp">
[WebMethod]
public static string Upload(string image)
{
    string APIKey = "LFuAPbLLyUtFTNIWwR9Tju/v7AApFGDFwSbodLB4xlQ5tBq3Bvq9ToFDrmsZxt3u1/qlAbu0B/RF4eJhpQUchA==";
    string AzureString = "DefaultEndpointsProtocol=https;AccountName=[AccountName];AccountKey=" + APIKey;
  
    byte[] bytes = Convert.FromBase64String(image);
  
    CloudStorageAccount storageAccount = CloudStorageAccount.Parse(AzureString);
  
    CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();
  
    CloudBlobContainer container = blobClient.GetContainerReference("img");
  
    string ImageFileName = RandomString(5) + ".jpg";
  
    CloudBlockBlob imgBlockBlob = container.GetBlockBlobReference(ImageFileName);
  
    using (MemoryStream ms = new MemoryStream(bytes))
    {
        imgBlockBlob.UploadFromStream(ms);
    }
  
    return "uploaded";
}
</pre>

<p>I have decorated this method with WebMethod attribute. This is necessary as I have to call this method from jQuery/javascript. Also the method should be public static. The <code>AzureString</code>  serves as the connection string for the cloud storage. You have to change the <code>[AccountName]</code> in the connection string to the storage account name. In my case it is propics. The method accepts the Base64 string as a parameter.</p>

<p><img src="/images/azure-storage-cam.png" alt="Azure storage container to save snaps" /></p>

<p>Storage is something different than that of the container and therefore I have to create a container which actually holds my images which I upload to the cloud storage. I am not explaining the code completely but it is not that complicate. To upload the file to the storage I must have a file name. The image I get from the canvas is just a Base64 string and does not have a name, so I have to give it a name. I have a random function which will generate the random string which I will be using as a file name for my image file.</p>

<pre class="brush: csharp">
//stole from http://stackoverflow.com/questions/1122483/c-sharp-random-string-generator
private static string RandomString(int size)
{
    Random _rng = new Random();
    string _chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  
    char[] buffer = new char[size];
  
    for (int i = 0; i < size; i++)
    {
        buffer[i] = _chars[_rng.Next(_chars.Length)];
    }
  
    return new string(buffer);
}
</pre>

<p>This is a small function which I stole from Stackoverflow to generate random name for my image file. So this is it and when I click the upload button on my page.</p>

<p><img src="/images/azure-cam-snap-in-action.png" alt="Web app showing images after snap" /></p>

<p>Now if I check my cloud storage I have can see the uploaded files.</p>

<p><img src="/images/azure-storage-snap-files.png" alt="Images uploaded o Azure storage from web app" /></p>

<p>This is just a simple example to get you started. You can give some cool effects before you can actually upload the files. If you do a quick search you’ll find plenty of links which will let you give some cool effects to your pictures. I came across a brilliant plugin called filtrr. You should try it and come up with something which is awesome or may be something like Instagram. Hope this help some folks out there.</p>

<h4 id="references">References:</h4>

<ul>
<li><a href="http://davidwalsh.name/browser-camera">David Walsh – Browser Camera</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/getusermedia/intro/">HTML5 – getUserMedia</a></li>
</ul>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/building-mvc-application-with-multiple-database-support-using-ninject/">Building MVC Application With Multiple Database Support Using Ninject</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> May 13, 2013
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/api">API</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/asp.net-mvc">ASP.NET MVC</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/c">C#</a>
      
      
      
      
    </span>
    

<p>I used to have <a href="http://blogengine.codeplex.com/">BlogEngine.NET</a> as my blogging platform before switching to <a href="http://wordpress.org/">WordPress</a>, and that is because of my poor hosting provider who can’t afford few MBs on the shared hosting plans. I like BlogEngine.NET a lot because it is in .NET and on the other hand WordPress is on PHP which I don’t know. BlogEngine.NET is still evolving and is getting better with every release. BlogEngine.NET supports multiple databases like SQL Server, SQL Server CE, MySQL, XML file, VistaDB and may be few more. As it is open-source, I jumped into the code and found it to be a bit hard to get through its implementation. To be frank, I didn’t look into that deep!! but it is not implementing what I was expecting it was. What I was expecting was the use of dependency injection (DI).</p>

<p>I am constantly working on new projects open-source and freelanced and few of them are for fun. The application I am working on right now requires a multiple DB support. The main problem I am going to face is not writing different functions for different DB operations, but having them integrated at the time when the user selects the database. BlogEngine.NET implements it pretty impressively, but I was expecting something else. For my project I will be using <a href="http://www.ninject.org/">Ninject</a>. If you want to do for your application, then this is how you can do it.</p>

<p>Create a new MVC internet application. First thing that we need to do is to add Ninject reference to the project by firing the below Nuget command. Remember that for MVC application you need to use Ninject.MVC3 and for other applications you need to use Ninject only: <code>Install-Package Ninject</code></p>

<pre class="brush: plain">
Install-Package Ninject.MVC3
</pre>

<p>When the library is installed successfully, you will notice a file under <code>App_Start</code> folder named <code>NinjectWebCommon.cs</code>. This is a very important file and we will look into it this later when we are done with other things.</p>

<p><img src="/images/ninject-installation.png" alt="ninject installtion in web app" /></p>

<p>What I am trying to achieve here is that my application would be able to support multiple databases and I also want to keep my code clean. I don’t want to handle it using some if..else conditions. Ninject does the work for me pretty well here. I will create an interface that will have all the functions which my wrapper classes will implement. For the sake of simplicity for this example I am going to perform basis CRUD operations, I will be writing code to implement two database support and will be using a custom written ORM called <a href="https://code.google.com/p/dapper-dot-net/">Dapper</a> to communicate to the DB (you can use EF if you wish). I will name my interface <code>IDBProvider</code>.</p>

<pre class="brush: csharp">
public interface IDBProvider
{
    bool Add(Friends friend);
    bool Update(int Id, Friends friend);
    bool Delete(int Id);
    IEnumerable ListFriends();
    Friends ListFriend(int Id);
}
</pre>

<p>As you can see from the above code that I am using <code>Friends</code> model to save details of my friend. So here is my model.</p>

<pre class="brush: csharp">
public class Friends
{
    [Key]
    public int Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public string Skype { get; set; }
}
</pre>

<p>After this I am going to have support for two databases, SQL Server and SQL Server CE (4.0). For this I will create 2 classes which will implement the <code>IDBProvider</code> interface naming <code>SQLHelper.cs</code> and <code>SQLCEHelper.cs</code> respectively.</p>

<h4 id="sqlhelper-cs">SQLHelper.cs</h4>

<pre class="brush: csharp">
public class SQLHelper : IDBProvider
{
    string ConStr = ConfigurationManager.ConnectionStrings["Con"].ConnectionString;
  
    public bool Add(Friends friend)
    {
        bool Added = false;
  
        try
        {
            using (SqlConnection con = new SqlConnection(ConStr))
            {
                string insertSQL = "INSERT INTO Friends(Name, Email, Skype) VALUES (@Name, @Email, @Skype)";
                con.Open();
                con.Execute(insertSQL, new
                {
                    friend.Name,
                    friend.Email,
                    friend.Skype
                });
  
                Added = true;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
  
        return Added;
    }
  
    public IEnumerable ListFriends()
    {
        try
        {
            using (SqlConnection con = new SqlConnection(ConStr))
            {
                string strQuery = "Select Id, Name, Email, Skype FROM Friends";
                con.Open();
                var AllFriends = con.Query(strQuery);
  
                return AllFriends;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
    }
  
    public Friends ListFriend(int Id)
    {
        try
        {
            using (SqlConnection con = new SqlConnection(ConStr))
            {
                string strQuery = "SELECT Id, Name, Email, Skype FROM Friends WHERE Id=" + Id;
                con.Open();
                var friend = con.Query(strQuery).Single();
                return friend;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
    }
  
    public bool Update(int Id, Friends friend)
    {
        bool Update = false;
        try
        {
            using (SqlConnection con = new SqlConnection(ConStr))
            {
                string strUpdate = "UPDATE Friends SET Name = @Name, Email = @Email, Skype = @Skype WHERE Id = " + Id;
                con.Open();
                con.Execute(strUpdate, new
                {
                    friend.Name,
                    friend.Email,
                    friend.Skype
                });
  
                Update = true;
            }
  
        }
        catch (Exception x)
        {
            throw x;
        }
  
        return Update;
    }
  
    public bool Delete(int Id)
    {
        bool Deleted = false;
        try
        {
            using (SqlConnection con = new SqlConnection(ConStr))
            {
                string strDelete = "DELETE FROM Friends WHERE Id = " + Id;
                con.Open();
                int i = con.Execute(strDelete);
                if (i > 0)
                    Deleted = true;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
  
        return Deleted;
    }
}
</pre>

<h4 id="sqlcehelper-cs">SQLCEHelper.cs</h4>

<pre class="brush:csharp">
public class SQLCEHelper : IDBProvider
{
    string ConStr = ConfigurationManager.ConnectionStrings["Con"].ConnectionString;
  
    public bool Add(Friends friend)
    {
        bool Added = false;
  
        try
        {
            using (SqlCeConnection con = new SqlCeConnection(ConStr))
            {
                string insertSQL = "INSERT INTO Friends(Name, Email, Skype) VALUES (@Name, @Email, @Skype)";
                con.Open();
                con.Execute(insertSQL, new
                {
                    friend.Name,
                    friend.Email,
                    friend.Skype
                });
  
                Added = true;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
  
        return Added;
  
    }
  
    public bool Update(int Id, Friends friend)
    {
        bool Update = false;
        try
        {
            using (SqlCeConnection con = new SqlCeConnection(ConStr))
            {
                string strUpdate = "UPDATE Friends SET Name = @Name, Email = @Email, Skype = @Skype WHERE Id = "+Id;
                con.Open();
                con.Execute(strUpdate, new
                {
                    friend.Name,
                    friend.Email,
                    friend.Skype
                });
  
                Update = true;
            }
  
        }
        catch (Exception x)
        {
            throw x;
        }
  
        return Update;
    }
  
    public bool Delete(int Id)
    {
         bool Deleted = false;
         try
         {
             using (SqlCeConnection con = new SqlCeConnection(ConStr))
             {
                 string strDelete = "DELETE FROM Friends WHERE Id = " + Id;
                 con.Open();
                 int i = con.Execute(strDelete);
                 if (i > 0)
                     Deleted = true;
             }
         }
         catch (Exception x)
         {
             throw x;
         }
  
         return Deleted;
    }
  
    public IEnumerable ListFriends()
    {
        try
        {
            using (SqlCeConnection con = new SqlCeConnection(ConStr))
            {
                string strQuery = "Select Id, Name, Email, Skype FROM Friends";
                con.Open();
                var AllFriends = con.Query(strQuery);
  
                return AllFriends;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
    }
  
    public Friends ListFriend(int Id)
    {
        try
        {
            using (SqlCeConnection con = new SqlCeConnection(ConStr))
            {
                string strQuery = "SELECT Id, Name, Email, Skype FROM Friends WHERE Id=" + Id;
                con.Open();
                var friend = con.Query(strQuery).Single();
                return friend;
            }
        }
        catch (Exception x)
        {
            throw x;
        }
    }
}
</pre>

<p>The question now here is that how would the application will know which DB to use as a data store? For this I made few settings in my web.config file. In the <code>appSettings</code> section I added a setting that will hold the value which we use as an identifier and connect to the DB. You can have different approach to achieve this, it is not at all necessary to use what I have used here. My app setting in web.config looks something like this:</p>

<pre class="brush: xml">
<add key="DBProvider" value="SQL"/>
</pre>

<p>When reading this settings I will be dynamically calling or injecting the code on the basis of the value of DBProvider in my app settings. In this case I will bind SQLHelper when the value is SQL and SQLCEHelper when the value is SQLCE. In the start of the tutorial I mentioned about the <code>NinjectWebCommon.cs</code> file in the <code>App_Start</code> folder. Here we will be looking into <code>CreateKernel</code> method as this is the place where I implement my helper classes.</p>

<pre class="brush: csharp; highlight: [7, 8, 9, 10, 11, 12, 13, 14]">
private static IKernel CreateKernel()
{
    var kernel = new StandardKernel();
    kernel.Bind&lt;Func&lt;IKernel&gt;&gt;().ToMethod(ctx =&gt; () =&gt; new Bootstrapper().Kernel);
    kernel.Bind&lt;IHttpModule&gt;().To&lt;HttpApplicationInitializationHttpModule&gt;();
  
    if (ConfigurationManager.AppSettings["DBProvider"].ToString().ToLower() == "sql")
    {
        kernel.Bind&lt;IDBProvider&gt;().To&lt;SQLHelper&gt;();
    }
    else
    {
        kernel.Bind&lt;IDBProvider&gt;().To&lt;SQLCEHelper&gt;();
    }
  
    RegisterServices(kernel);
    return kernel;
}
</pre>

<p>Notice the highlighted code. I am conditionally binding the implementation on the basis of the settings in my web.config file. What exactly is happening here is that the code is being injected depending on the conditions and this is why we call it dependency injection.</p>

<p>To get the benefit of this, we need to make few changes to our controller.</p>

<pre class="brush: csharp">
private readonly IDBProvider _dbProvider;
  
public HomeController(IDBProvider dbProvider)
{
    this._dbProvider = dbProvider;
}
</pre>

<p>I have a default constructor which takes the IDBProvider as a parameter. The IDBProvider object is all we need which provides us all its implementation. To add a friend to DB you just have to call the Add method like <code>_dbProvider.Add(friend)</code>. Same for edit, update, delete and list all the friends. You noticed that no where in the code I have made use of the SQLHelper.cs or SQLCEHelper.cs classes. This is the awesomeness of DI.</p>

<p>This is all it and now your application is flexible enough to use multiple databases. I strongly recommend you to read the documentation on Ninject at <a href="http://ninject.org/">Ninject.org</a> as it is vast and can be a life saver in many scenarios.</p>

  </div>
  
  <div class="post-list__item">
    <span class="item__title--big">
      <a href="/post/async-controller-in-mvc-4/">ASYNC Controller In MVC 4</a>
      
    </span>
    <span class="item__date">
      <i class="fas fa-calendar-alt"></i> Apr 30, 2013
    </span>
    
    <span>
      
      
      
      
      
      
      <a class="badge badge-category" href="/category/.net-framework">.NET FRAMEWORK</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/asp.net-mvc">ASP.NET MVC</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/c">C#</a>
      &nbsp;
      
      <a class="badge badge-category" href="/category/visual-studio">VISUAL STUDIO</a>
      
      
      
      
    </span>
    <p>I have build many small applications so far in MVC to help myself in understanding the framework more deeply. Now I am planning to write a blog engine on MVC. It will not be an easy task but I will be going to learn a lot of things. As I was planning things ahead I came across a problem where I have to load my blog stats like FeedBurner readers, Facebook page likes, Google +1 count, twitter followers inside a div on the page. The problem I see here is that I am going to make multiple cross-domain calls in order to get the stats. I can’t avoid that though but this will cause my blog to load slowly. I know about <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh156513.aspx">Async</a> and <a href="http://msdn.microsoft.com/en-IN/library/dd537609.aspx">Task Parallel Library(TPL)</a> but the question is how do I implement this in my application? I do a quick web search and found something which is called Async controller in MVC4. You can also have <a href="http://msdn.microsoft.com/en-us/library/system.web.mvc.asynccontroller(v=vs.108).aspx">AsynController</a> in MVC3 but that is not pretty if you start comparing it with MVC4.</p>

<p>For the simplicity of the tutorial I am going to make 2 calls: get twitter followers count and facebook page likes. In MVC3, if you want to perform Async operations then you have to inherit your controller with AsyncController like this.</p>

<pre class="brush: csharp">
public class HomeController : AsyncController
</pre>

<p>But MVC4 is much cleaner. Let’s take a look at the default implementation of the calls I am making to Twitter and Facebook to get the follower count and page likes respectively. Here are my 2 methods in HomeController.</p>

<pre class="brush: csharp">
private string GetTwitterFollowersCount(string Username)
{
    XDocument xdoc = XDocument.Load("http://api.twitter.com/1/users/show.xml?screen_name=" + Username + "&include_entities=false");
    return (from item in xdoc.Descendants("user")
            select item.Element("followers_count").Value)
            .SingleOrDefault();
}
  
private string GetFacebookLikes(string FaceBookPageURL)
{
    string uri = "https://api.facebook.com/method/fql.query?query=select%20%20like_count,%20total_count,%20share_count,%20click_count%20from%20link_stat%20where%20url=%22" + FaceBookPageURL + "%22";
    return Convert.ToString((from elem in XElement.Load(uri).Descendants()
                   where elem.Name.LocalName == "like_count"
                   select elem).First&lt;XElement&gt;().Value);
}
</pre>

<p>Nothing fancy in the above two methods. When I call these 2 methods one after the other, they will just get the data from a different source and render the result in the view. That’s fine as it’s my requirement. Now when I run my application it now takes a longer time to render the view. Before I explain this further take a look at my <code>Index()</code>.</p>

<pre class="brush: csharp">
public ActionResult Index()
{
    Stopwatch watch = new Stopwatch();
    watch.Start();
    ViewBag.TwitterFollowers = GetTwitterFollowersCount("audi");
    ViewBag.FacebookLikes = GetFacebookLikes("http://facebook.com/audi");
    watch.Stop();
    Int64 elapsedTime = watch.ElapsedMilliseconds;
    ViewBag.Time = elapsedTime.ToString();
    return View();
}
</pre>

<p>This is because Controllers are synchronous by default and it will process the request one after the other i.e. it will wait for the first task to complete and then move on to the next task. In my case the controller will execute the <code>GetFollowersCount</code> method and only after the completion of this method it will shift to the next method <code>GetFacebookLikes</code>. This could be a long running task or just imagine if you are retrieving heavy data from different sources. The view or the page will not render till the execution of both the methods will not get completed. To get a rough idea of the time elapsed in making synchronous calls in the above controller, I have used <a href="http://msdn.microsoft.com/en-IN/library/system.diagnostics.stopwatch.aspx">StopWatch(System.Diagnostics)</a> class. I don’t know how accurate, but I still used it to have an approximate idea of the time. This is the output of the above code.</p>

<p><img src="/images/async-controller-call.png" alt="Async controller in action" /></p>

<p>It took <code>1588ms</code> to complete 2 requests. Now if I implement async in the controller I will see a drastic improvement. It is not just the controller <code>ActionResult</code> which I have to change to support async calls but I also have to update the 2 methods which I am using to collect the stats. Here are my updated methods.</p>

<pre class="brush: csharp">
private Task&lt;string&gt; GetTwitterFollowersCountAsync(string Username)
{
    return Task.Run(() =>
    {
        XDocument xdoc = XDocument.Load("http://api.twitter.com/1/users/show.xml?screen_name=" + Username + "&include_entities=false");
        return (from item in xdoc.Descendants("user")
                select item.Element("followers_count").Value).SingleOrDefault();
    });
}
  
private Task&lt;string&gt; GetFacebookLikesAsync(string FaceBookPageURL)
{
    return Task.Run(() =>
    {
        string uri = "https://api.facebook.com/method/fql.query?query=select%20%20like_count,%20total_count,%20share_count,%20click_count%20from%20link_stat%20where%20url=%22" + FaceBookPageURL + "%22";
        return Convert.ToString((from elem in XElement.Load(uri).Descendants()
                                 where elem.Name.LocalName == "like_count"
                                 select elem).First&lt;XElement&gt;().Value);
    });
}
</pre>

<p>Pay attention to the <code>GetTwitterFollwersCountAsync</code> and <code>GetFacebookLikesAsync</code> return type. Previously they were only string, and now I have changed their return type to Task. I have put the code inside <a href="http://msdn.microsoft.com/en-IN/library/system.threading.tasks.task.run.aspx">Task.Run()</a> as it will queues the specified work to run on the Thread Pool and returns a <code>Task(TResult)</code> handle for that work. I have changed the ActionResult to handle the async feature. As you can see that this controller method does not return ActionResult instead it return Task. Here is my updated ActionResult.</p>

<pre class="brush: csharp highlight: [5,6,7]">
public async Task&lt;ActionResult&gt; Index()
{
    Stopwatch watch = new Stopwatch();
    watch.Start();
    Task&lt;string&gt; twitterFollowers = GetTwitterFollowersCountAsync("audi");
    Task&lt;string&gt; facebookLikes = GetFacebookLikesAsync("http://facebook.com/audi");
    await Task.WhenAll(twitterFollowers, facebookLikes);
    ViewBag.TwitterFollowers = await twitterFollowers;
    ViewBag.FacebookLikes = await facebookLikes;
    watch.Stop();
    Int64 elapsedTime = watch.ElapsedMilliseconds;
    ViewBag.Time = elapsedTime.ToString();
    return View();
}
</pre>

<p>The code is almost the same but 3 lines are making a difference (highlighted). Task will hold the value returned from the updated async methods. MSDN defines the <a href="http://msdn.microsoft.com/en-us/library/vstudio/hh156528.aspx">await</a> operator as:</p>

<blockquote>
<p>The await operator is applied to a task in an asynchronous method to suspend the execution of the method until the awaited task completes. The task represents ongoing work.</p>
</blockquote>

<p><a href="http://msdn.microsoft.com/en-IN/library/system.threading.tasks.task.whenall.aspx">Task.WhenAll()</a> will creates a task that will complete when all of the supplied tasks have completed. This actually parallelize the request. Lets check the output and compare both.</p>

<p><img src="/images/async-controller-async-action.png" alt="Async controller in action with improvement" /></p>

<p>The difference is noticeable…607ms!! is half way down and a huge performance benefit. This is a small example and the real performance can be noticed when you work with real scenarios. I have used MVC4 with .NET 4.5 to use awesomeness of asynchronous controller. I hope this gives you an idea on how you can use async controllers in MVC4.</p>

  </div>
  
</div>


<ul class="pagination">
    
    <li class="page-item">
        <a href="/" class="page-link" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li class="page-item">
    <a href="/page/7/" class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/">1</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/2/">2</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/3/">3</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item disabled"><span aria-hidden="true">&nbsp;&hellip;&nbsp;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/7/">7</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item active"><a class="page-link" href="/page/8/">8</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/9/">9</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="page-item disabled"><span aria-hidden="true">&nbsp;&hellip;&nbsp;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li class="page-item"><a class="page-link" href="/page/33/">33</a></li>
    
    
    <li class="page-item">
    <a href="/page/9/" class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li class="page-item">
        <a href="/page/33/" class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>


        </div>
        



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-8994557-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>

<link
  href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shCore.min.css"
  rel="stylesheet"
/>
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/styles/shThemeDefault.min.css"
  rel="stylesheet"
/>

<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shCore.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCSharp.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCss.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushJScript.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPlain.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushSql.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushXml.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPowerShell.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushPython.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushBash.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushCpp.min.js"
></script>
<script
  type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/SyntaxHighlighter/3.0.83/scripts/shBrushRuby.min.js"
></script>

<script>
  SyntaxHighlighter.defaults["gutter"] = true;
  SyntaxHighlighter.defaults["smart-tabs"] = true;
  SyntaxHighlighter.defaults["auto-links"] = true;
  SyntaxHighlighter.defaults["collapse"] = false;
  SyntaxHighlighter.defaults["light"] = false;
  SyntaxHighlighter.defaults["tab-size"] = 4;
  SyntaxHighlighter.defaults["toolbar"] = false;
  SyntaxHighlighter.defaults["wrap-lines"] = true;
  SyntaxHighlighter.all();
</script>


    </body>
</html>
